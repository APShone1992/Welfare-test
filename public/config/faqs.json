

/*************************************************
 * FAQ DATA (UNCHANGED STRUCTURE)
 *************************************************/
const FAQ_DATA = [
  {
    "id": "hours",
    "question": "What are your opening times?",
    "answer": "We’re open <b>Monday–Friday, 08:30–17:00</b>.",
    "synonyms": [
      "When do you open?",
      "Business hours",
      "What time are you open?",
      "Opening hours",
      "Office hours",
      "When do you opne?",
      "Buisness hours",
      "Opning hours",
      "Opening tims",
      "Opening timez",
      "When are you openning?"
    ],
    "keywords": ["open", "closing", "time", "weekday", "mon-fri"],
    "followups": [
      { "id": "holiday-hours", "label": "What about bank holidays?" },
      { "id": "contact", "label": "Who can I call if I’m unsure?" },
      { "id": "emergency-support", "label": "Do you help out of hours?" }
    ],
    "redirects": [
      { "match": "after hours", "to": "emergency-support" },
      { "match": "out of hours", "to": "emergency-support" }
    ]
  },
  {
    "id": "holiday-hours",
    "question": "What are your holiday hours?",
    "answer": "Public holiday hours may differ. We’ll post updates on our website and social channels ahead of time.",
    "keywords": ["holiday", "bank", "christmas", "easter"],
    "followups": [
      { "id": "hours", "label": "Regular opening times" },
      { "id": "contact", "label": "Confirm with the team" }
    ]
  },
  {
    "id": "contact",
    "question": "How can I contact support?",
    "answer": "Email us at support@Kelly.co.uk or call <b>01234 567890</b>.",
    "keywords": ["call", "phone", "email", "contact"],
    "followups": [
      { "id": "hours", "label": "When are you open?" },
      { "id": "emergency-support", "label": "Is there urgent support?" }
    ]
  },
  {
    "id": "emergency-support",
    "question": "Do you offer emergency support?",
    "answer": "Yes, emergency support is available for business‑critical incidents. Call the main number and select <b>Option 1</b>.",
    "keywords": ["urgent", "emergency", "critical", "p1"],
    "followups": [
      { "id": "contact", "label": "Contact details" }
    ]
  }
];

/*************************************************
 * SESSION MEMORY (GITHUB FRIENDLY)
 *************************************************/
const memory = {
  answeredIds: new Set(
    JSON.parse(sessionStorage.getItem("answeredIds") || "[]")
  ),
  askedFollowUps: new Set(
    JSON.parse(sessionStorage.getItem("askedFollowUps") || "[]")
  )
};

function saveMemory() {
  sessionStorage.setItem(
    "answeredIds",
    JSON.stringify([...memory.answeredIds])
  );
  sessionStorage.setItem(
    "askedFollowUps",
    JSON.stringify([...memory.askedFollowUps])
  );
}

/*************************************************
 * MAIN RESPONSE FUNCTION
 *************************************************/
function respondToUser(userText) {
  const text = userText.toLowerCase();
  let entry = null;

  /***********************
   * 1️⃣ REDIRECT MATCHING
   ***********************/
  for (const e of FAQ_DATA) {
    if (e.redirects) {
      const redir = e.redirects.find(r =>
        text.includes(r.match)
      );
      if (redir) {
        entry = FAQ_DATA.find(x => x.id === redir.to);
        break;
      }
    }
  }

  /***********************
   * 2️⃣ STANDARD MATCH
   ***********************/
  if (!entry) {
    for (const e of FAQ_DATA) {
      if (
        text.includes(e.question.toLowerCase()) ||
        e.synonyms?.some(s => text.includes(s.toLowerCase())) ||
        e.keywords?.some(k => text.includes(k))
      ) {
        entry = e;
        break;
      }
    }
  }

  /***********************
   * 3️⃣ FALLBACK
   ***********************/
  if (!entry) {
    return {
      answer: "Sorry, I didn’t quite understand that.",
      followUp: null
    };
  }

  memory.answeredIds.add(entry.id);

  /***********************
   * 4️⃣ CONTEXT‑AWARE FOLLOW‑UP (NON‑REPEATING)
   ***********************/
  let followUp = null;

  if (entry.followups?.length) {
    const intents = [
      { key: "holiday", words: ["holiday", "bank", "christmas", "easter"] },
      { key: "emergency", words: ["urgent", "emergency", "out of hours"] },
      { key: "contact", words: ["call", "email", "phone"] },
      { key: "hours", words: ["open", "opening", "time", "hours"] }
    ];

    const detected = intents.find(i =>
      i.words.some(w => text.includes(w))
    );

    if (detected) {
      followUp = entry.followups.find(f =>
        f.id.includes(detected.key) &&
        !memory.askedFollowUps.has(f.id)
      );
    }

    if (!followUp) {
      followUp = entry.followups.find(f =>
        !memory.askedFollowUps.has(f.id)
      );
    }

    if (followUp) {
      memory.askedFollowUps.add(followUp.id);
    }
  }

  saveMemory();

  /***********************
   * 5️⃣ FINAL RESPONSE
   ***********************/
  return {
    answer: entry.answer,
    followUp: followUp ? followUp.label : null
  };
}

/*************************************************
 * ✅ EXAMPLE TESTS (REMOVE IN PROD)
 *************************************************/
// console.log(respondToUser("What time are you open?"));
// console.log(respondToUser("Are you open on Christmas?"));
// console.log(respondToUser("I need urgent support"));
// console.log(respondToUser("How do I contact you?"));
